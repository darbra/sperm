> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [blog.betamao.me](https://blog.betamao.me/posts/2021/some-ebook-decrypt/)

> å¾ˆä¹…æ²¡åˆ†æäº† android åº”ç”¨äº†ï¼Œå†æ²¡æœ‰å¤§å­¦æ—¶é‚£ç§ä¸€å¤©ä¸åƒé¥­å¹²ä¸€ä¸ª APP çš„æ¿€æƒ…äº†... æœ€åï¼Œèƒ½ç”¨å°±è¡Œå§ï¼

æ¢äº† MBA åä¹ æƒ¯è£…ä¸Šé˜…è¯»å™¨ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡ç”¨å°±è¢«æƒŠåˆ°äº†ï¼Œä¸çŸ¥é“è¿™æ˜¯æœ‰æ„ä¸ºä¹‹è¿˜æ˜¯å‡ºäº† BUGï¼Œåæ­£ç­‰äº†å‡ ä¸ªæœˆå®˜æ–¹ä¹Ÿä¸ä¿®ï¼Œæ²¡åŠæ³•å°±æ‰“ç®—æŠŠä¹¦æå‡ºæ¥ç”¨è‡ªå¸¦çš„ BOOK é˜…è¯»äº†ï¼š  

![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632371846910-cb0cbf7c-c690-4b2d-a2e5-0a63ae8bf4c7.png)

> âš ï¸âš ï¸âš ï¸æ³¨ï¼šæœ¬æ–‡åªæ˜¯ä¸ºäº†æŠ€æœ¯äº¤æµï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±åˆ†æè‡ªå·±ç”¨ï¼Œæœ¬æ–‡ä¸æä¾›è„šæœ¬æˆ–ç”µå­ä¹¦ä¸‹è½½ï¼å¦å¤–ï¼Œä¸ºäº†é˜²æ­¢è¢«ç›´æ¥æ‹¿å»ä¸‹è½½ï¼Œæœ¬æ–‡å¿½ç•¥äº†ä¸€äº›å°ç»†èŠ‚ï¼Œè§£å¯†éœ€è¦åˆ†ææ•´ä¸ªè¿‡ç¨‹ï¼

å®‰å“é€†å‘åŸºç¡€
------

æŒ‰æƒ¯ä¾‹ï¼Œè¡¥ç‚¹åŸºç¡€ï¼Œç„¶é¹…å¿˜å¾—å·®ä¸å¤šäº†ï¼Œä»¥åæƒ³åˆ°ä»€ä¹ˆå†è¡¥å§

### å·¥å…·

å·¥æ¬²é‚£å•¥å¿…é¡»é‚£å•¥ï¼ŒAndroid åˆ†æçš„å·¥å…·å¤ªå¤šäº†ï¼Œæœ‰äº›å°å·¥å…·ä¼šæ‰“åŒ…æˆå·¥å…·ç®±ï¼Œæ¯”å¦‚ AndroidKillerï¼ŒAPKIDE ç­‰ï¼Œè¿˜æœ‰å¾ˆå¤šæ˜¯å•ç‹¬çš„å·¥å…·æˆ–è„šæœ¬ï¼Œä¸‹é¢å°±ç®€å•è®°å½•ä¸€äº›å¸¸ç”¨çš„ï¼Œè¿˜æœ‰å¾ˆå¤šå¾ˆå¤šå¾ˆå¤šä¼šåœ¨æŸæ¬¡åˆ†æä¸­ç”¨åˆ°ï¼Œå°±ä¸å†™äº†...

#### è¿è¡Œ

1.  æ‰‹æœºï¼Œä½ éœ€è¦ä¸€å°å°ç±³ 10 å—·æ¬»~~ æ‰æ€ª~~ï¼Œå¤ªæ–°çš„æ‰‹æœºä¹Ÿä¸å¥½ï¼Œæˆ‘ç”¨çš„å°ç±³ 2 ç‰¹æ–¹ä¾¿ã€‚ä¸ç„¶çš„è¯ç”¨æ¨¡æ‹Ÿå™¨ä¹Ÿå¯ä»¥ï¼Œæ¯”å¦‚[è“å ](https://www.bluestacks.com/)ï¼Œå¯ä½¿ç”¨ä¿®æ”¹å™¨ [root](https://bstweaker.tk/)ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ¬¡åˆ†æçš„çˆ±å±å±æ²¡æœ‰ x86 çš„åŠ¨æ€åº“ï¼Œè€Œ frida å¯¹æ¨¡æ‹Ÿå™¨åªèƒ½ä½¿ç”¨ x86 çš„ serverï¼Œå¹¶ä¸”è‹¥è¦ hook arm çš„åº“éœ€ä½¿ç”¨ [realm](https://frida.re/news/2021/02/10/frida-14-2-released/)ã€‚
2.  [ADB](https://developer.android.com/studio/command-line/adb) ç­‰å·¥å…·ï¼Œç®€å•è¯´æ˜ä¸‹ ADB åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼Œæœ¬ç”µè„‘ä½¿ç”¨çš„ adb å’Œ adb-server åŠè¢«è°ƒè¯•æ‰‹æœºè¿è¡Œçš„ adbdï¼Œæ‰§è¡Œ adb çš„å¤§éƒ¨åˆ†å‘½ä»¤ä¼šå¯åŠ¨å¹¶è¿æ¥ adb-serverï¼Œç”±å®ƒé€šè¿‡ [usb / ç½‘ç»œ](https://developer.android.com/studio/run/device)ä¸ adbd é€šä¿¡ï¼Œadbd æ‰§è¡Œå®é™…å‘½ä»¤ï¼Œé»˜è®¤ adbd è¿è¡Œæƒé™ä¹Ÿä¸é«˜ï¼Œå¯ç”¨ adb root ä½¿å®ƒä»¥ root èº«ä»½å¯åŠ¨ï¼Œå…¶ä»–å¸¸ç”¨å‘½ä»¤å¯è§ [adbsehll](https://adbshell.com/)ã€‚é‚£ä¸€å¥—å¸¸ç”¨çš„è¿˜æœ‰ [Logcat](https://developer.android.com/studio/command-line/logcat?hl=zh-cn)ï¼Œ[DDMS](https://developer.android.com/studio/profile/monitor) ç­‰ã€‚

#### åˆ†æ

[JEB](https://www.pnfsoftware.com/) å’Œ [GDA](http://www.gda.wiki:9090/index.php) å·®ä¸å¤šä¸»è¦ç”¨äºåˆ†æ Java å±‚ä»£ç ï¼Œ[IDA](https://hex-rays.com/ida-pro/) ç”¨äºåˆ†æå’Œè°ƒè¯• so æ–‡ä»¶

#### ç½‘ç»œ

è¿™é‡Œåˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æŠ“åŒ…çš„ï¼Œæ¯”å¦‚ [r0capture](https://github.com/r0ysue/r0capture)ï¼Œ[proxydroid](https://github.com/madeye/proxydroid)ï¼Œå¦ä¸€ç±»æ˜¯åˆ†æçš„ï¼Œæ¯”å¦‚ [charles](https://www.charlesproxy.com/)ï¼Œ[fiddler](https://proxyman.io/posts/2019-10-26-Alternatives-for-charles-proxy-and-wireshark)ï¼Œ[wireshark](https://www.wireshark.org/)ï¼Œ[burpsuite](https://portswigger.net/burp) ç­‰

#### è‡ªåŠ¨è„±å£³

[FRIDA-DEXDump](https://github.com/hluwa/FRIDA-DEXDump) å’Œ [Frida-Apk-Unpack](https://github.com/GuoQiang1993/Frida-Apk-Unpack) éƒ½æ˜¯ä½¿ç”¨ Frida å®ç°çš„è‡ªåŠ¨åŒ–è„±å£³è„šæœ¬ï¼Œè€Œ [FART](https://github.com/hanbinglengyue/FART) æ˜¯åŸºäº Android 6.0 å®ç°çš„ ART ç¯å¢ƒä¸‹é€šè¿‡ä¸»åŠ¨è°ƒç”¨çš„è‡ªåŠ¨åŒ–è„±å£³æ–¹æ¡ˆã€‚

#### è°ƒè¯•æ’æ¡©

[xposed](https://repo.xposed.info/) å’Œ [cydia](http://www.cydiasubstrate.com/) æ˜¯æ¯”è¾ƒç»å…¸çš„ hook æ¡†æ¶ï¼Œå‰è€…ä¸»è¦ç”¨äº Java å±‚è€Œåè€…ç”¨äº Native å±‚ï¼Œç°åœ¨æ›´å¤šçš„ä¼šä½¿ç”¨ [Frida](https://frida.re/)ï¼Œå®ƒåŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©å·¥å…·ï¼Œå¯ä»¥åš objcï¼Œjavaï¼Œnative çš„ HOOKï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢å¾ˆå¤šå·¥å…·æ˜¯åŸºäºå®ƒçš„ï¼Œä¹‹åæœ‰æ—¶é—´ä¼šå•ç‹¬å‡ºä¸€ç¯‡åˆ†ææ–‡ç« ã€‚

### é¸¡è¯†

å®‰å“å°± Linux ä¸ŠåŠ ä¸ªæ‰‹æœºæ¡†æ¶ï¼Œæ¡†æ¶ä¸»è¦ç”¨ Java è™šæ‹Ÿæœº (dalvik/art) è¿è¡Œç¨‹åºï¼Œå’Œ hotspot çš„æ ˆæœºä¸åŒï¼Œå®ƒæ˜¯åŸºäºå¯„å­˜å™¨çš„ï¼Œä¹Ÿä¸ä½¿ç”¨ Java æ ‡å‡†çš„ class ç»“æ„ï¼Œä½†æ˜¯å¾ˆç±»ä¼¼ï¼Œæ¯”å¦‚å®ƒçš„æ±‡ç¼– smali å…¶å®å¾ˆåƒæ™®é€šçš„å­—èŠ‚ç ï¼Œåªæ˜¯è¯´é‡Œé¢æœ‰å¯„å­˜å™¨äº†ï¼Œå…¶å®è¿™é‡Œé¢çš„ä¸œè¥¿éƒ½æ˜¯å¯ä»¥ç›¸äº’è½¬åŒ–çš„ã€‚å¦å¤–ç¨‹åºä¹Ÿå¯ä»¥è¿è¡Œ Native çš„ç¨‹åºæˆ–è°ƒç”¨ Native çš„åº“ï¼Œä¸€åŠçš„çˆ±å±å±å°±æ˜¯ Javaï¼‹æ”¯æŒ JNI è¯­è¨€ (æ¯”å¦‚ C/C++) å†™ç»“åˆ(å¯å‚è€ƒ [cxm](https://www.zybuluo.com/cxm-2016/note/563686))ï¼Œæ˜¾ç„¶ Java çš„å­—èŠ‚ç æ–‡ä»¶å¾ˆå®¹æ˜“åç¼–è¯‘ä¸º Java ä»£ç ï¼Œè¿™ä¸æ¯«ä¸å½±å“é˜…è¯»ï¼Œè€Œå…¶ä»–ç¼–è¯‘ä¸º Native ä»£ç çš„éƒ¨åˆ†å°±å¯ä»¥æŠŠå®¢æˆ·ç«¯ä¸Šé‚£å¥—ä¿æŠ¤æœºåˆ¶ç›´æ¥å¥—ä¸Šï¼Œå†µä¸”å»ç¬¦å·çš„äºŒè¿›åˆ¶æ–‡ä»¶æœ¬èº«åˆ†æå°±æ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥ç°åœ¨çš„ä¿æŠ¤æ€è·¯ä¹Ÿæ˜¯ Java è½¬ Nativeï¼Œè€Œä¹‹å‰çš„é‚£å‡ ä»£åœ¨ Java å±‚é¢çš„ä¿æŠ¤ä¹Ÿå°±æ˜¯ä»£ç æ··æ·†ï¼Œä»£ç æŠ½å–ï¼Œå‰è€…æˆ‘ä»¬æœ¨çš„åŠæ³•å’¯ä½†æ˜¯ä»£ç æŠ½å–çš„å†™ä¸ªè„šæœ¬ä¹Ÿèƒ½å¼„å‡ºæ¥ï¼Œæ›´å¤šå¯ä»¥çœ‹ OWASP çš„[æ–‡æ¡£](https://mobile-security.gitbook.io/mobile-security-testing-guide/)ã€‚  

è¯´å›ç ´è§£æœ¬èº«ï¼Œå¤§ä½“å’Œå®¢æˆ·ç«¯ä¸€è‡´ï¼Œå…ˆç†Ÿæ‚‰ä¸‹ç¨‹åºï¼Œææ¸…æ¥šç›®æ ‡æ˜¯å•¥ï¼Œå†é™æ€åˆ†æçœ‹çœ‹æ•´ä½“é•¿å•¥æ ·ï¼Œæ‰¾æ‰¾å…³é”®ç‚¹ï¼Œå…³é”®ç‚¹ä¹Ÿæ˜¯é‚£å‡ æ‹³ï¼Œä»€ä¹ˆæŠ“åŒ…ï¼Œå­—ç¬¦ä¸²ï¼Œé…ç½®ï¼Œå…ƒä¿¡æ¯ï¼Œå®šä½åˆ°å…³é”®ç‚¹å†æ‰©å±•ä¸€é¡¿æ“ä½œå°±ğŸ†—å•¦ï¼  
â€‹  

### è°ƒè¯•

åˆ†ä¸º Java çš„å’Œ Native çš„ï¼Œå‰è€…ä¸€èˆ¬ç”¨ idea/as è°ƒå®ƒçš„ smali ä»£ç ï¼Œåº”ç”¨åœ¨å¯åŠ¨æ—¶è‹¥å…¨å±€è®¾ç½®äº† ro.debuggable=1 æˆ–æœ¬åœ°çš„ AndroidManifest.xml è®¾ç½®äº† android:debuggable="true" åˆ™ä¼šåˆ›å»ºè°ƒè¯•çº¿ç¨‹ï¼Œç”¨æˆ·åˆ™å¯ä»¥é™„åŠ è°ƒè¯•ï¼›

```
java -jar apktool.jar d t.apk -o out # è§£åŒ…
java -jar apktool.jar b out -o t.apk # æ‰“åŒ…
sign t.apk  # æ¯ä¸ªapkéƒ½éœ€è¦ç­¾åï¼Œå¯ä»¥æƒ³æƒ³è‡ªç­¾åä¹Ÿè¡Œçš„é‚£ç­¾åçš„æ„ä¹‰
shell adb shell am start -D -n <packagename>/<MainActivity> # ä»¥è°ƒè¯•çš„æ–¹å¼å¯åŠ¨ï¼Œæ­¤æ—¶ä¼šæŒ‚èµ·è¿›ç¨‹
adb forward tcp:8700 jdwp:<pid> # åˆ›å»ºç«¯å£è½¬å‘


```

åè€…ä¸€èˆ¬ç”¨ ida çš„ dbg_server è°ƒï¼Œè¿™å’Œæ™®é€šçš„ Linux ç¨‹åºè°ƒè¯•æ²¡å¤ªå¤§åŒºåˆ«ï¼Œåªæ˜¯åœ¨ç”¨ USB è¿æ¥æ—¶ï¼Œéœ€è¦ç”¨ adb è¿›è¡Œç«¯å£è½¬å‘

```
adb push android_server /data # è¿™ä¸ªç›®å½•å¥½å‘€ï¼Œå¯å†™å¯æ‰§è¡Œ
# ä¹Ÿå¯ä»¥æ”¾æ ¹ç›®å½•ï¼Œéœ€è¦æ”¹æƒé™ mount -o rw,remount /
chmod +x android_server 
adb forward tcp:23946 tcp:23946  # é€šè¿‡adbç«¯å£è½¬å‘


```

### åè°ƒè¯•

å…¶å®åè°ƒå°±é‚£ä¸¤ç§å¥—è·¯ï¼šæ£€æµ‹è°ƒè¯•ä¸å¯¹æŠ—è°ƒè¯•ï¼Œæ£€æµ‹å°±æ˜¯è‹¥æœ‰è°ƒè¯•å™¨å°±è¿›å…¥éæ­£å¸¸é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æµ‹è‡ªèº«çŠ¶æ€ (å¦‚è‡ªèº« status æ–‡ä»¶ï¼Œä½¿ç”¨ ptrace) ä¸æ£€æµ‹å¤–éƒ¨ç¯å¢ƒ(å¦‚ç›‘å¬äº† 23946 ç­‰ç«¯å£ï¼Œè¿è¡Œç€åä¸º gdb çš„è¿›ç¨‹ç­‰)ï¼›è€Œå¯¹æŠ—å°±æ˜¯ä½¿ç”¨ä¸è°ƒè¯•å™¨æœ‰å†²çªçš„åŠŸèƒ½å®ç°æ­£å¸¸é€»è¾‘ï¼ˆå¦‚éšè—è‡ªèº«è¿›ç¨‹ï¼ŒåŒå­è¿è¡Œï¼Œå¼‚å¸¸è¿è¡Œï¼‰ï¼Œè¿™æ ·æœ‰è°ƒè¯•å™¨æ—¶ç¨‹åºå°±æ— æ³•æ­£å¸¸è¿è¡Œã€‚

åè°ƒè¯•æ˜¯ä¸€ç§åˆçº§çš„å¯¹æŠ—æ‰‹æ®µï¼Œå› ä¸ºå®ƒæ˜¯å¯é€†çš„ï¼Œæ‰€ä»¥æ‰¾åˆ°å…³é”®ç‚¹ pass æ‰å°±å¥½äº†ï¼Œè¿™é‡Œè®°å½•ä¸€äº›ç‚¹ï¼š

1.  æŸ¥çœ‹ / proc/\<pid>/ ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚ status çš„ TracePidï¼Œstat çš„æ ‡å¿—ï¼Œwchan ç­‰
2.  ä½¿ç”¨ ptrace è¿›è¡ŒåŒå­æ‰§è¡Œæˆ–è€…ä½¿ç”¨ PT_DENY_ATTACH ç­‰
3.  æ£€æŸ¥è¿›ç¨‹åï¼Œç›‘å¬çš„ç«¯å£
4.  é€šè¿‡ä¸€äº›ç³»ç»Ÿæä¾›çš„æ¥å£ï¼Œå¦‚ isDebuggerConnected

é˜…è¯» APP åˆ†æ
---------

### åˆ†æè¦è§£å¯†çš„æ–‡ä»¶

é¦–å…ˆï¼Œæ‰¾ä¸ªè¿œå¤æ—¶ä»£çš„ç‰ˆæœ¬ï¼Œå› ä¸ºè¶Šæ–°çš„ä¿æŠ¤å¯èƒ½åšçš„è¶Šå¥½ï¼Œæˆ‘ä»¬çš„ç›®çš„ä¸æ˜¯çœ‹å®ƒæ€ä¹ˆä¿æŠ¤çš„ï¼Œè€Œæ˜¯å¼„å‡ºç®—æ³•å°±è¡Œã€‚å¯ä»¥å»[è±Œè±†èš](https://www.wandoujia.com/)æ‰¾æ‰¾ï¼Œä¸€èˆ¬éƒ½æœ‰ï¼Œæ¯”å¦‚ç§‹ç§‹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632566080580-31626003-cc8d-42c6-9c7e-f0febf516ece.png)  
ä¸€èˆ¬å‡çº§éƒ½ä¼šå…¼å®¹æ—§ç‰ˆçš„ï¼Œæ‰€ä»¥ç®—æ³•ä¸ä¼šå˜ï¼Œå³ä½¿å˜ä¹Ÿå¯ä»¥äº†è§£ä¸‹åˆä»£çš„æ ·å­ï¼Œä¸‹è½½å®‰è£…å¥½ä¹‹åå°±å¯ä»¥è¿è¡Œå®ƒï¼Œç™»å½•è´¦å·ä¸‹å‡ æœ¬ä¹¦åé€€å‡ºï¼Œå…ˆçœ‹çœ‹ä¹¦æœ¬èº«çš„æ ·å­ï¼Œåƒä¹¦ç±è¿™ç§æ¯”è¾ƒå¤§çš„æ•°æ®å®ƒä»¬éƒ½å–œæ¬¢æ”¾ sdcard é‡Œï¼Œæœ€ç»ˆåœ¨`/storage/emulated/0/Android/data/com.jingdong.app.reader.campus/files/`é‡Œæ‰¾åˆ°äº†ä¸‹è½½çš„ä¹¦ï¼Œå®ƒä»¬ä»¥ JEB åç¼€å‘½åï¼Œä½†æ˜¯éƒ½æ— æ³•æ‰“å¼€ï¼Œå…ˆä½¿ç”¨ binwalk å¯¹æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œepub å¦‚ä¸‹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632208064514-a865a6de-1bb4-4e14-b298-1268c8feb194.png)  
è§£å‹åå‘ç°å›¾ç‰‡æ­£å¸¸ï¼Œè€Œæ–‡å­—è¢«åŠ å¯†æ— æ³•æ­£å¸¸æ˜¾ç¤ºï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632208212398-3ea90174-2d5f-4aa3-8dff-581fc3d950f0.png)  
è€Œå¯¹äº pdf æ–‡ä»¶ï¼Œå¯è§å®ƒä¹Ÿä½¿ç”¨è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨è¿›è¡Œäº†åŠ å¯†ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632304287169-6da7b2de-b055-432a-88a9-fbe19f494759.png)  
â€‹  

### åˆ†ææ•°æ®åº“

åœ¨ç§»åŠ¨ç ´è§£ä¸­ï¼Œæ•°æ®åº“é‡Œé¢ä¼šæœ‰å¾ˆå¤šæœ‰ç”¨çš„çº¿ç´¢ï¼Œæ‰€ä»¥å¯ä»¥å…ˆçœ‹çœ‹ï¼Œæ•°æ®åº“ä¸€èˆ¬ä¼šä¿å­˜åœ¨`/data/data/com.jingdong.app.reader.campus/databases`ï¼Œå–å‡ºæ•°æ®åº“ï¼Œç›´æ¥æ‰“å¼€è¢«å‘ŠçŸ¥æ–‡ä»¶é SQLite æ–‡ä»¶æˆ–å·²è¢«åŠ å¯†ï¼Œæ²¡åŠæ³•åªèƒ½å…ˆçœ‹ apk æ–‡ä»¶äº†ï¼Œç”¨ GDA æ‰“å¼€ï¼Œæœç´¢ SQL/SELECT ç­‰å…³é”®å­—ï¼Œä¼šå‘ç°æ•°æ®åº“ä½¿ç”¨äº† [greendao](http://greenrobot.org/)ï¼Œæ‰“å¼€å®˜ç½‘å‘ç°å®ƒæ”¯æŒä½¿ç”¨ [sqlcipher](https://www.zetetic.net/sqlcipher/) åŠ å¯†æ•°æ®åº“ï¼Œä» so æ–‡ä»¶å¯ä»¥çœ‹å‡ºæ˜¯ç‰ˆæœ¬ 3ï¼š

```
.rodata:00119EFB aCipherVersion  DCB "cipher_version",0  ; DATA XREF: sqlcipher_codec_pragma_0+178â†‘o
.rodata:00119EFB                                         ; sqlcipher_codec_pragma_0:off_6F6F8â†‘o
.rodata:00119F0A a340            DCB "3.4.0",0           ; DATA XREF: sqlcipher_codec_pragma_0+18Eâ†‘o


```

  
sqlcipher v3 ä½¿ç”¨ AES256 CBC æ¨¡å¼åŠ å¯†ï¼š  

1.  æŠŠä¸€ä¸ªæ•°æ®åº“åˆ†æˆå¤šä¸ª chunk(ä¹Ÿå¯ä»¥æŠŠå®ƒå«åš page, é»˜è®¤å¤§å°ä¸º 4kB)ï¼Œæ¯ä¸ª chunk å•ç‹¬åŠ å¯†ï¼Œæ˜¾ç„¶ password æ˜¯ç›¸åŒçš„ã€‚
2.  ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ª chunk æœ‰è‡ªå·±çš„ ivï¼Œiv è¢«å­˜åœ¨æ¯ä¸ª chunk çš„æœ«å°¾ï¼Œå¦å¤–æ¯æ¬¡å†™æ•°æ®éƒ½ä¼šç”Ÿæˆæ–°çš„ ivã€‚
3.  å¯¹æ¯ä¸ª chunkï¼Œå¯¹ iv ä¸å¯†æ–‡ç”Ÿæˆ MAC(é»˜è®¤ HMAC-SHA512)ï¼Œè¯»æ—¶åšæ ¡éªŒ
4.  å¯¹æ¯ä¸ªæ•°æ®åº“ï¼Œä¼šç”Ÿæˆä¸€ä¸ª 16B çš„ç›ï¼Œå­˜å‚¨åœ¨æ–‡ä»¶å¼€å§‹å¤„ã€‚åŠ å¯†å¯†é’¥ä½¿ç”¨ PBKDF2-HMAC-SHA512 æ–¹å¼ï¼Œé»˜è®¤è¿­ä»£ 256000 æ¬¡ã€‚
5.  HMAC çš„ key ä¸åŠ å¯†çš„ key ä¸åŒï¼Œå‰è€…ç”±åè€…ä½¿ç”¨ PBKDF2 è¿›è¡ŒäºŒæ¬¡è¿­ä»£åŠä¸€æ¬¡äº¤æ¢ç”Ÿæˆã€‚
6.  è‹¥ä¸ºäº†æ˜¾ç¤ºé­”æ•°ç­‰ä¿¡æ¯è€Œæ”¾å¼ƒå¯¹æ•°æ®åº“å¤´éƒ¨åŠ å¯†ï¼Œé‚£ä¹ˆç›åªèƒ½è¢«å­˜åœ¨å¤–éƒ¨ï¼Œæ¯æ¬¡æ‰“å¼€æ•°æ®åº“æ—¶æ˜¾å¼æŒ‡å‡ºã€‚
7.  å…¶ä»–ã€‚ã€‚ã€‚

ä¸è¿‡ä¸é‡è¦ï¼Œç½‘ä¸Šä¸€é€šæœç´¢çŸ¥é“äº†æ€ä¹ˆç”¨å·¥å…·è§£å¯†ï¼š

```
sqlcipher-shell32.exe sk.db
sqlite> PRAGMA KEY = 'exm';
sqlite> ATTACH DATABASE 'sk_plaintext.db' AS plaintext KEY '';
sqlite> SELECT sqlcipher_export('plaintext');


```

é€šè¿‡å…¨æ–‡æœç´¢`getEncryptedWritableDb`æˆ–è€…`getEncryptedreadableDb`å¯ä»¥å®šä½åˆ°è·å¾—åŠ å¯†æ•°æ®åº“å®åŠ›çš„ä»£ç å¤„ï¼Œå›æº¯å¯ä»¥åˆ†æå…¶å¯†é’¥ç”Ÿæˆç®—æ³•ï¼Œç„¶è€Œã€‚ã€‚ã€‚ã€‚å®ƒçš„å¯†é’¥æ˜¯ç¡¬ç¼–ç çš„ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632567764223-f3519cb1-8829-45ff-9480-96df1b9225ea.png)

<table><thead><tr><th>åº“å</th><th>å¯†ç </th></tr></thead><tbody><tr><td>books.db</td><td>SessionBookDataUtil</td></tr><tr><td>plugin.db</td><td>SessionPluginDataUtil</td></tr><tr><td>sync.db</td><td>SessionSyncDataUtil</td></tr><tr><td>team.db</td><td>SessionTeamDataUtil</td></tr><tr><td>chapter_divisions_book_store.db</td><td>password</td></tr><tr><td>download_failed_record.db</td><td>password</td></tr><tr><td>file_store.db</td><td>password</td></tr><tr><td>the_whole_book_store.db</td><td>password</td></tr></tbody></table>

æŠŠæ•°æ®åº“è§£å¯†ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶çš„è§£å¯† key æ¥è‡ª books.db çš„ key åˆ—ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632568105067-009347cf-143b-41d7-81d8-171c725554a6.png)  

### åˆ†æ DEX

çœ‹åˆ°è¿™é‡Œæˆ‘ä¸‹è½½çš„ç‰ˆæœ¬æ˜¯æ²¡æœ‰åšå…¶ä»–åŠ å›ºçš„ï¼Œåªæœ‰éƒ¨åˆ†åœ°æ–¹æœ‰æ··æ·†ï¼Œé€šè¿‡æœç´¢ openbookï¼Œencryptï¼Œdecrypt ç­‰å¯ä»¥å‘ç° com.jingdong.app.reader.main.action.OpenBookAction é‡Œæœ‰å¦‚ä¸‹å†…å®¹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632568439903-cb7711e9-082b-4390-92e1-7643b1fffc07.png)  
ç»åˆ†æ arg11 æ˜¯ com.jingdong.app.reader.data.database.dao.books.JDBookDao è¡¨çš„æ˜ å°„ï¼Œæ‰€ä»¥é€šè¿‡æ•°æ®åº“æ“ä½œä¸å…³é”®è¯å¯å®šä½åˆ° com.jd.read.engine.jni.DocViewï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632568781640-3d095023-bda7-4832-a8bd-d6bda67db26a.png)  
å¯è§æŠŠè¿™äº›æ•°æ®ä¼ å…¥åˆ° so é‡Œäº†ï¼Œå¦å¤–å®ƒçš„å¦ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¹¦ç±æ˜¯å¦å®Œæ•´è¿˜æ˜¯åˆ†ç« ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632207679223-18160771-e9e9-4ca0-b7f0-9ff04ad767b3.png)

### åˆ†æ SO

ä¸Šé¢å·²ç»çŸ¥é“æ€ä¹ˆè°ƒç”¨ so äº†ï¼Œç°åœ¨å°±ç›´æ¥åˆ†æå®ƒï¼Œå®ƒæ˜¯ libDecryptorJni.so æ–‡ä»¶ï¼Œå®šä½å‡½æ•°æ—¶ï¼Œå¦‚æœæ—¶æ ‡å‡†çš„å‡½æ•°åå°±æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¦åˆ™ä» JNI_OnLoad(registerNativeMethods) é‡Œé¢æ‰¾ï¼Œä¸è¿‡è¿™é‡Œå®ƒç”¨çš„æ ‡å‡†åç§°ï¼  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632569289125-c990c231-ebf3-4441-8c06-39c2a979ca68.png)  
è¿™é‡Œç”¨ jeb èƒ½å¾ˆå¥½è¯†åˆ« ENV ä¸ [arm çš„ç‰¹å®šæŒ‡ä»¤](https://www.kernel.org/doc/Documentation/arm/kernel_user_helpers.txt)ï¼Œå¦‚ä¸‹åœ¨ IDA ä¸­æ— æ³•è¯†åˆ«ï¼Œé‡åˆ°è¿™ç§ç›´æ¥è·³è¿‡å³å¯ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632569468475-b1d2d6a1-eaf5-4af0-b1e6-5dec34e2acf1.png)  
å› ä¸ºä¹ æƒ¯ç”¨ IDAï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨å®ƒæ¥ç€æï¼Œç»§ç»­åˆ†æå¯ä»¥çœ‹åˆ°å®ƒæ ¹æ®ç±»å‹ä½¿ç”¨ä¸‰ç§ä¸åŒçš„æ–¹å¼è§£å¯†æ•°æ®ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632569725923-4c7e2541-531d-40c6-a864-9a890b0f4479.png)  
ç½‘ç»œç±»å‹çš„ä¼šç”Ÿæˆç”¨ç°æœ‰çš„ key ç”Ÿæˆä¸€ä¸ªæ–°çš„ keyï¼Œåˆ†ç« èŠ‚çš„åªæ˜¯ä½¿ç”¨äº†ä¼ å…¥çš„ KEYï¼Œè€Œå®Œæœ¬çš„æŠŠä¼ å…¥çš„ Keyï¼ŒDeviceID å’Œ Random å…¨éƒ¨ä¼ å…¥äº†ï¼Œæ‰€ä»¥å…ˆçœ‹ç½‘ç»œç±»å‹ç”Ÿæˆæ–° Key çš„ç®—æ³•å§ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632569975667-8a326f57-37eb-4fae-9139-e4fac9b83be2.png)  
æ²¡æœ‰å»ç¬¦å·ï¼Œæ‰€ä»¥ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ˜¯ä¸ªåŒé‡ MD5ï¼š

```
def generate_net_book_key(data: bytes):
    data = md5(data).digest()
    data = md5(data).hexdigest().upper()
    return data.encode()


```

ç„¶åæ˜¯å®Œæœ¬çš„ï¼Œå®ƒä¼šè°ƒç”¨ GetContentKeyBufï¼Œè€Œ GetContentKeyBuf åˆä¼šè°ƒç”¨ j_j_AnalyticRightFileBufï¼Œåè€…çš„ç»“æœä¸­å°†ä¼šåŒ…å« ID å’Œ CKï¼Œè¿”å›çš„æ˜¯ CKï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632570204336-08e0c641-a400-4a9f-912a-02d2ca0600ac.png)  
ç»§ç»­è·Ÿå…¥ j_j_AnalyticRightFileBufï¼Œåç»­ä»£ç å¤ªå¤šå°±ä¸æˆªå›¾äº†ï¼Œç›´æ¥è´´ä»£ç ï¼š

```
// key = 0001xxxxxxx<HS>0044yyyyyyy
v8 = (unsigned __int8 *)j_memstr((char *)a1, a2, "<HS>", 4);   // æˆªå–<HS>ä¹‹åçš„éƒ¨åˆ†ï¼Œå‰å››å­—èŠ‚æ˜¯é•¿åº¦ï¼Œä»è€Œè·å–åé¢çš„æ•°æ®
j_base64Decode(v12, v31, (char *)v11)       // è§£ç æ•°æ®ï¼Œçœ‹åé¢å¯çŸ¥å®ƒæ˜¯32å­—èŠ‚çš„hashå€¼
    v28 = (char *)v11;
*(_DWORD *)v45 = (((a1[3] << 8) | a1[2]) << 16) | (a1[1] << 8) | *a1;   // è·å–keyå‰å››å­—èŠ‚ï¼Œåšç‰ˆæœ¬å·
v13 = a2 - 12 - v31;
v14 = j_DecryptByVersion((char *)a1 + 4, v13, &v42, &v41, v45);  // ç»§ç»­è§£å¯†
v40 = 0;
v39 = 0;
j_j_Hash_256((int)v42, v41, (int)&v40, (int)&v39);  
j_memcmp(v40, v28, 32)  // åˆ¤æ–­è§£å¯†åçš„æ•°æ®çš„hashæ˜¯å¦ä¸hashä¸€è‡´
 ... 
j_DecryptCK(v42, v41, v38, v37, v36, v35, a5, a6); // æ‰€æœ‰å¤„ç†å®Œçš„æ•°æ®ä¸€èµ·å†è¿›è¡Œè§£å¯†


```

#### DecryptByVersion

ç»§ç»­å…¥ j_DecryptByVersionï¼Œéœ€è¦ç‰ˆæœ¬å·ä¸º 0001ï¼Œä¹‹åä¼šè°ƒç”¨ StringDecryptQomolangma:

```
v9 = j_strcmp(a5, "0001");
v10 = j_j_StringDecryptQomolangma(a1, a2, a3, a4);


```

æ¥ç€è·Ÿå…¥ StringDecryptQomolangmaï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632570970077-593a371d-3e4e-489e-90d7-a521a8e07d9f.png)  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632571050342-b2cc8823-0b1e-43c3-b3f6-88d1a602df50.png)  
å…ˆè¯´æœ€åä¸€ç§å˜æ¢å§ï¼Œå°±å¾ˆç®€å•çš„:

```
    res = []
    a_ascii, z_ascii, A_ascii, Z_ascii, zero_ascii, nine_ascii = map(ord, ('a', 'z', 'A', 'Z', '0', '9'))
    for c in data:
        if a_ascii <= c <= z_ascii:
            c -= 3
            c = c if c >= a_ascii else c + 26
        elif A_ascii <= c <= Z_ascii:
            c -= 3
            c = c if c >= A_ascii else c + 26
        elif zero_ascii <= c <= nine_ascii:
            c -= 1
            c = c if c >= zero_ascii else nine_ascii
        res.append(c)
    data = bytes(res)


```

ç°åœ¨åˆ†æé‚£ä¸‰ä¸ªå‡½æ•°ï¼š

##### j_JY_Crypt

![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632571271045-3f5efc5d-92cc-4e81-a3bb-8908ff4e178f.png)  
å¾ˆæ˜æ˜¾æ˜¯ RC4 ç®—æ³•ï¼Œä¸å¤šè¯´ã€‚

##### BillDecode

ç»æŸ¥è¯¢ï¼Œå®ƒå’Œç½‘ä¸Šçš„æŸç§ DRM è§£ç å¾ˆåƒï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632571463682-74b43891-3271-4bc5-a0ae-5ae1244e46d7.png)  
ç»åˆ†æå®ƒç”¨äº†è‡ªé€‚åº”çš„è§£ç ç®—æ³•ï¼Œå¦‚ä¸‹ï¼š

```
BILL_TABLE0 = b"n5Pr6St7Uv8Wx9YzAb0Cd1Ef2Gh3Jk4M"
BILL_TABLE1 = b"AaZzB0bYyCc1XxDdW2wEeVv3FfUuG4g-TtHh5SsIiR6rJjQq7KkPpL8lOoMm9Nn_"


def bill_decode(data: bytes):
    result = b''
    for c in BILL_TABLE0[:8]:
        if data[0] == c:
            table = BILL_TABLE0
            break
    else:
        for c in BILL_TABLE1[:4]:
            if data[0] == c:
                table = BILL_TABLE1
                break
        else:
            raise Exception('????')

    for i in range(0, len(data) - 1, 2):
        high = table.find(data[i])
        low = table.find(data[i + 1])
        if (high == -1) or (low == -1):
            break
        value = (((high * len(table)) ^ 0x80) & 0xFF) + low
        result += byte(value)
    return result


```

##### ExchangeChar

![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632571572113-0aeb1499-6ea5-4968-859c-a9914aac6ab8.png)  
è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„äº¤æ¢ï¼Œä»¥ 8 å­—èŠ‚ä¸ºå•ä½ï¼š

```
def exchange_char(data: bytes) -> bytes:
    res = bytearray(data)
    for i in range(0, len(data), 8):
        res[i:i + 8] = data[i:i + 8][::-1]
    return bytes(res)


```

#### DecryptCK

è¯¥å‡½æ•°å¤§è‡´å¦‚ä¸‹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632571972479-d0a6dcf9-506d-4894-8edb-ec6d7dc4ead4.png)  
å®ƒè§£å¯†äº†èµ·å§‹çš„ 32 å­—èŠ‚ï¼Œå¹¶è¿æ¥å‰©ä½™æ•°æ®å†ç”¨ä¹‹å‰åˆ†æçš„ç®—æ³•è§£ç ï¼Œè¿™é‡Œè¿˜éœ€è¦æ³¨æ„ AES è§£å¯†çš„å·¥ä½œæ¨¡å¼ï¼Œå®ƒå…¶å®ç”¨çš„æ˜¯ CBC æ¨¡å¼ï¼ŒIV è¢«ç¡¬ç¼–ç è¿›å»äº†ï¼Œå…¨æ˜¯ 0:

```
IV = b'0000000000000000'

def aes_pkcs7pad_decrypt(key: bytes, data: bytes):
    key = sha256(key).digest()
    cipher = AES.new(key, IV=IV, mode=AES.MODE_CBC)
    plain = cipher.decrypt(data)
    return pkcs7_unpad(plain)


```

#### jddecompress

ç»¼ä¸Šï¼Œå®Œæœ¬çš„ä¹Ÿè§£å¯†å®Œäº†ï¼Œç»ˆäºè½®åˆ°è§£å¯†ä¹¦ç±çš„éƒ¨åˆ†äº†ï¼Œå®ƒä»¬ä½¿ç”¨äº†åŒæ ·çš„é€»è¾‘ï¼Œå°±æ˜¯ AES è§£å¯†ä¹‹åå†è§£å‹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632572397344-c43b8ffc-febd-4270-b460-c2f083d3ef5d.png)  
æœ€åå°±æ˜¯è§£å¯†äº†ï¼Œä¸»è¦æˆ‘æƒ³è¯´ PDF è§£å¯†ï¼Œç°åœ¨å·²çŸ¥ PDF ä½¿ç”¨äº† filter å»åŠ è§£å¯†æ•°æ®ï¼Œéœ€è¦å»å†™ä¸€ä¸ªè§£å¯†å·¥å…·ï¼Œæœ¬æ¥æˆ‘åœ¨ç½‘ä¸Šæœäº†ä¸ª[åº“](https://github.com/jsvine/pdfplumber)ï¼Œçœ‹äº†ä¸‹å®ƒä¸æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œåˆæ‰“äº†ä¸ªè¡¥ä¸è®©å®ƒå»è§£å¯†ï¼š

```
    old_get_data = PDFStream.get_data
    old_get_filters = PDFStream.get_filters

    def get_data(self):
        old_filters = old_get_filters(self)
        for (f, params) in old_filters:
            if f.name == 'JDPDFENCRYPTBY360BUY':
                try:
                    self.rawdata = aes_pkcs7pad_decrypt(key, self.rawdata[:-1])
                except Exception as e:
                    print(e)
        return old_get_data(self)

    def get_filters(self):
        old_filters = old_get_filters(self)
        for (f, params) in old_filters:
            if f.name == 'JDPDFENCRYPTBY360BUY':
                old_filters.remove((f, params))
        return old_filters

    PDFStream.get_data = get_data
    PDFStream.get_filters = get_filters


```

ç„¶é¹…ï¼Œè§£å®Œå¯†ç¿»ä»£ç æ²¡æ‰¾åˆ° save æ–¹æ³•ï¼Œç¿»æ–‡æ¡£æ‰å‘ç°å®ƒä¸æ”¯æŒä¿®æ”¹æ–‡ä»¶...  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632314409430-59c8589d-3a54-4e11-8ab6-76276e1c2d85.png)  
ï¼ï¼ï¼ï¼æœ€åï¼Œæ ¹æ® [pdf æ–‡ä»¶æ ¼å¼](https://resources.infosecinstitute.com/topic/pdf-file-format-basic-structure/)ï¼ŒèŠ±äº†å¥½å‡ ä¸ªæ™šä¸Šå†™äº†ä¸ªç®€æ˜“çš„è§£æç±»æ‰è‚å‡ºæ¥ï¼Œç®€å•è¯´ä¸‹ï¼ŒPDF ä»å°¾éƒ¨å‘å‰è§£æï¼Œå…ˆè¯» trailer è·å– xrefï¼Œå†æ ¹æ®å®ƒè§£æå¯¹è±¡ï¼Œå¯¹è±¡åªéœ€è¦å…³æ³¨ stream å¯¹è±¡ï¼ŒæŠŠå®ƒè§£å¯†å¹¶å»æ‰å­—å…¸é‡Œçš„è¿‡æ»¤å™¨ï¼Œå†è°ƒæ•´å‡ ä¸ªè¡¨çš„åç§»å³å¯ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632572972232-f6ab2c51-2288-4466-8384-f8c12bd7616b.png)  
æœ€åçš„ç»“æœå¦‚ä¸‹ï¼š  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632486531303-78fb3d64-7aa3-414b-a061-ce9f8c137af0.png)  

æœ€åæœ€åæœ€å
------

æ¬¢è¿å­Ÿæ™šèˆŸå›å®¶ï¼ï¼ï¼ï¼ï¼  
![](https://blog.betamao.me/posts/2021/some-ebook-decrypt/pic/1632579205049-f611a98a-818b-44ba-921f-bfe1026536eb.png)

Powered by [Pelican](https://getpelican.com/), Theme by [B3taMa0](#), Based on [Smashing Magazine](https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/)