> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/cvORMGjd-qfPM_pqozirdA)

åœ¨ Android åº”ç”¨çš„é€†å‘å·¥ç¨‹ä¸å®‰å…¨å¯¹æŠ—ä¸­ï¼Œ**åè°ƒè¯•æŠ€æœ¯**ä¸€ç›´æ˜¯å¼€å‘è€…å’Œé€†å‘åˆ†æäººå‘˜ä¹‹é—´çš„åšå¼ˆé‡ç‚¹ã€‚åº”ç”¨å¼€å‘è€…é€šè¿‡å„ç§æ‰‹æ®µæ£€æµ‹è°ƒè¯•å™¨æˆ– Hook å·¥å…·ï¼ˆå¦‚ Fridaã€Xposedï¼‰çš„å­˜åœ¨ï¼Œè€Œé€†å‘å·¥ç¨‹å¸ˆåˆ™ä¼šå°è¯•ç»•è¿‡è¿™äº›æ£€æµ‹ï¼Œä»¥ä¾¿è¿›è¡ŒåŠ¨æ€è°ƒè¯•ã€æ³¨å…¥æˆ–å†…å­˜åˆ†æã€‚

å…¶ä¸­ï¼Œä¸€ç±»å¸¸è§çš„æ£€æµ‹æ–¹å¼æ˜¯é€šè¿‡**çº¿ç¨‹æ£€æµ‹**æ¥å®Œæˆçš„ã€‚æœ¬æ–‡å°†ä»çº¿ç¨‹åˆ›å»ºçš„æµç¨‹å…¥æ‰‹ï¼Œé€æ­¥å‰–æç›¸å…³åŸç†ï¼Œå¹¶ä»‹ç»å¦‚ä½•åœ¨æ”»é˜²å¯¹æŠ—ä¸­é€šè¿‡ hook æŠ€æœ¯åº”å¯¹çº¿ç¨‹æ£€æµ‹ã€‚

åè°ƒè¯•æ£€æµ‹ä¸­çš„ â€œçº¿ç¨‹æ‰‹æ®µâ€
--------------

å¾ˆå¤šå®‰å…¨æ£€æµ‹é€»è¾‘ï¼ˆä¾‹å¦‚å®šæ—¶æ£€æŸ¥è°ƒè¯•å™¨çŠ¶æ€ã€æ‰«æå†…å­˜ã€ç›‘æ§å¯ç–‘æ¨¡å—ï¼‰éƒ½ä¼šåœ¨**æ–°çº¿ç¨‹**ä¸­æ‰§è¡Œã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯ï¼š

*   â€¢ ä¿è¯æ£€æµ‹é€»è¾‘ä¸ä¸»çº¿ç¨‹è§£è€¦ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œï¼›
    
*   â€¢ æ£€æµ‹é€»è¾‘èƒ½å‘¨æœŸæ€§åœ°æ‰§è¡Œï¼Œæé«˜æ£€æµ‹ç¨³å®šæ€§ï¼›
    
*   â€¢ çº¿ç¨‹éšè—åœ¨å¤§é‡ä¸šåŠ¡çº¿ç¨‹ä¸­ï¼Œå¢åŠ é€†å‘åˆ†æéš¾åº¦ã€‚
    

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½åœ¨Â **æ–°çº¿ç¨‹å¯åŠ¨é˜¶æ®µ**Â è¿›è¡Œæ‹¦æˆªï¼Œå°±æœ‰æœºä¼šåœ¨ç¬¬ä¸€æ—¶é—´è¯†åˆ«å¹¶ç»•è¿‡è¿™äº›æ£€æµ‹ã€‚

pthread_createï¼šç¬¬ä¸€ä¸ªæƒ³åˆ°çš„ Hook ç‚¹
----------------------------

åœ¨ Linux / Android ç³»ç»Ÿä¸­ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ ¸å¿ƒ API æ˜¯Â `pthread_create`ã€‚å¾ˆå¤šäººä¼šæƒ³åˆ°ç›´æ¥ hook è¿™ä¸ªå‡½æ•°ï¼Œæ¥æ‹¦æˆªæ‰€æœ‰æ–°çº¿ç¨‹çš„åˆ›å»ºã€‚

ç„¶è€Œï¼Œ`pthread_create`Â æœ¬èº«è¿‡äºæ˜¾çœ¼ï¼Œå®‰å…¨å‚å•†å’Œåº”ç”¨å¼€å‘è€…å¾€å¾€ä¼š**é‡ç‚¹æ£€æµ‹è¿™ä¸ªå‡½æ•°æ˜¯å¦è¢«ç¯¡æ”¹**ã€‚å¦‚æœç›´æ¥ hookï¼Œå¾ˆå®¹æ˜“åè¢«æ£€æµ‹å‡ºæ¥ï¼Œå¯¼è‡´åº”ç”¨ç›´æ¥å´©æºƒæˆ–è¿›å…¥é˜²å¾¡æ¨¡å¼ã€‚

å› æ­¤ï¼Œ**ä¸è¦ç›´æ¥ hook****`pthread_create`**ï¼Œæˆ‘ä»¬éœ€è¦æ›´éšè”½çš„åˆ‡å…¥ç‚¹ã€‚

æ·±å…¥åˆ†æï¼šçº¿ç¨‹å¯åŠ¨æµç¨‹
-----------

çº¿ç¨‹çš„å®é™…å¯åŠ¨æµç¨‹å¹¶ä¸æ˜¯ç®€å•åœ°åœç•™åœ¨Â `pthread_create`ï¼Œå…¶è°ƒç”¨é“¾å¤§è‡´å¦‚ä¸‹ï¼š

```
pthread_create -> clone -> æ–°çº¿ç¨‹ -> __start_thread -> __pthread_start -> æ‰§è¡Œç”¨æˆ·ä»£ç 

```

å…³é”®ç‚¹æœ‰ä¸¤ä¸ªï¼š

*   â€¢Â **`__start_thread`**ï¼šè¿™æ˜¯æ–°çº¿ç¨‹çš„å…¥å£å‡½æ•°ï¼Œè´Ÿè´£åˆå§‹åŒ–çº¿ç¨‹ç¯å¢ƒï¼Œå¹¶è°ƒç”¨Â `__pthread_start`ã€‚
    
*   â€¢Â **`__pthread_start`**ï¼šæœ€ç»ˆåœ¨æ–°çº¿ç¨‹ç¯å¢ƒä¸­æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„å‡½æ•°ï¼ˆå³ç”¨æˆ·ä»£ç ï¼‰ã€‚
    

ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹çš„çœŸæ­£ â€œèµ·è·‘çº¿â€ åœ¨Â `__start_thread`Â ä¸Â `__pthread_start`Â ä¹‹é—´ã€‚

IDA åˆ†æ libc
-----------

è¦æ›´æ¸…æ¥šåœ°ç†è§£è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¼å‡º Android ç³»ç»Ÿçš„Â `libc.so`ï¼Œå¹¶ç”¨ IDA åˆ†æï¼š

```
adb pull /system/lib64/libc.so

```

åœ¨ IDA ä¸­æ‰¾åˆ°Â `__start_thread`Â å’ŒÂ `__pthread_start`Â çš„å®ç°ï¼Œå¯ä»¥æ¸…æ™°çœ‹åˆ°å®ƒä»¬å¦‚ä½•ä»å‚æ•°ä¸­å–å‡ºç”¨æˆ·ä»£ç çš„å…¥å£åœ°å€ï¼Œå¹¶æœ€ç»ˆè·³è½¬æ‰§è¡Œã€‚

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FMiaMMfBpPgBWFqgVUeawE6tCFDsKOyz9VOu8eyWeYojibJMRjnjKEVODVjlWCuwsWkGWdT5LFSBtP5DtFhtRT7g/640?wx_fmt=png&from=appmsg&watermark=1)

ä¾‹å¦‚ï¼Œåœ¨Â `__pthread_start`Â çš„æ±‡ç¼–ä¸­ï¼š

```
MOV Â  Â  Â  Â  Â  Â  X19, X0 Â  ; X0 æ˜¯ __pthread_start çš„ç¬¬ 0 ä¸ªå‚æ•°
......
LDP Â  Â  Â  Â  Â  Â  X8, X0, [X19,#0x60]
BLR Â  Â  Â  Â  Â  Â  X8 Â  Â  Â  Â ; è°ƒç”¨ç”¨æˆ·ä»£ç 

```

å…¶ä¸­ï¼š

*   â€¢Â `X8`Â å­˜æ”¾ç”¨æˆ·ä»£ç çš„åœ°å€ï¼›
    
*   â€¢Â `X0`Â æ˜¯ä¼ ç»™ç”¨æˆ·ä»£ç çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
    

è¿™æ„å‘³ç€æˆ‘ä»¬åªè¦åœ¨Â `__start_thread`Â æˆ–Â `__pthread_start`Â å¤„ hookï¼Œå°±èƒ½æ‹¿åˆ°æ–°çº¿ç¨‹çš„ç”¨æˆ·ä»£ç å…¥å£åœ°å€ã€‚

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FMiaMMfBpPgBWFqgVUeawE6tCFDsKOyz9MjyVVY1HnQtABm0mT43JOQKdbyVW6ZQ7X2ibqJhepa9UHatKBOq8EJw/640?wx_fmt=png&from=appmsg&watermark=1)

å¦‚ä½•è§£æç”¨æˆ·çº¿ç¨‹åœ°å€
----------

`__start_thread`Â ä¸Â `__pthread_start`Â éƒ½å¯ä»¥ä½œä¸º hook ç‚¹ã€‚

*   â€¢Â `__start_thread`Â ä¼šå°†å‚æ•°ç›´æ¥é€ä¼ ç»™Â `__pthread_start`ï¼›
    
*   â€¢ å‚æ•°ä¸­åŒ…å«äº†ç”¨æˆ·ä»£ç åœ°å€ï¼Œåªéœ€ä»åç§»Â `0x60`Â å¤„è¯»å–å³å¯ã€‚
    

ç¤ºä¾‹ï¼ˆFrida ä¼ªä»£ç ï¼‰ï¼š

```
thread.add(0x60).readPointer(); Â // è·å–ç”¨æˆ·ä»£ç åœ°å€

```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“æ–°çº¿ç¨‹çœŸæ­£è¦æ‰§è¡Œçš„å‡½æ•°ä½ç½®ï¼Œä»è€Œå†³å®šæ˜¯å¦æ”¾è¡Œã€‚

Hook ç¤ºä¾‹ï¼šæ‹¦æˆªçº¿ç¨‹åˆå§‹åŒ–
---------------

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ Frida ä¸­ hookÂ `__pthread_start`ï¼š

```
functionÂ hook_start_thread() {
Â  Â Â varÂ libc =Â Process.findModuleByName("libc.so");
Â  Â Â varÂ addr_start_thread = libc.base.add(0xCB5D8);Â // __pthread_start åç§»
Â  Â Â varÂ original_start_thread =Â newÂ NativeFunction(addr_start_thread,Â "void", ["pointer"]);

Â  Â Â Interceptor.replace(addr_start_thread,Â newÂ NativeCallback(functionÂ (thread) {
Â  Â  Â  Â Â varÂ user_func_addr = thread.add(0x60).readPointer();
Â  Â  Â  Â Â varÂ nice_addr =Â addr2nice(user_func_addr);

Â  Â  Â  Â Â console.log("thread start: "Â + nice_addr);

Â  Â  Â  Â Â ifÂ (nice_addr.includes("libfrida.so")) {Â 
Â  Â  Â  Â  Â  Â Â // æ£€æŸ¥æ˜¯å¦ä¸º Frida æˆ–å…¶ä»–æ¶æ„æ¨¡å—åˆ›å»ºçš„çº¿ç¨‹
Â  Â  Â  Â  Â  Â Â console.log("frida check thread detected");
Â  Â  Â  Â  }Â elseÂ {
Â  Â  Â  Â  Â  Â Â // æ­£å¸¸çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
Â  Â  Â  Â  Â  Â Â original_start_thread(thread);
Â  Â  Â  Â  }
Â  Â  },Â "void", ["pointer"]));
}
hook_start_thread();

```

è¿™ä¸ª Hook åšäº†å‡ ä»¶äº‹ï¼š

1.  1.Â **æ‹¦æˆªæ–°çº¿ç¨‹å¯åŠ¨**ï¼›
    
2.  2.Â **æå–ç”¨æˆ·ä»£ç åœ°å€**ï¼›
    
3.  3.Â **æ£€æŸ¥åˆ›å»ºçº¿ç¨‹çš„æ¨¡å—**ï¼ˆå¦‚ Fridaï¼‰ï¼›
    
4.  4.Â **å†³å®šæ˜¯å¦æ”¾è¡ŒåŸå§‹å‡½æ•°**ã€‚
    

æœ¬æ–‡ä»çº¿ç¨‹è§’åº¦åˆ‡å…¥ï¼Œä»‹ç»äº†åè°ƒè¯•æ£€æµ‹ä¸­çš„ä¸€ç§å¸¸è§æ‰‹æ®µï¼Œå¹¶æ·±å…¥åˆ†æäº†çº¿ç¨‹å¯åŠ¨æµç¨‹ä¸­éšè—çš„å…³é”®å‡½æ•°Â `__start_thread`Â å’ŒÂ `__pthread_start`ã€‚ç›¸æ¯”ç›´æ¥ HookÂ `pthread_create`ï¼Œé€‰æ‹©æ›´æ·±å±‚çš„å…¥å£èƒ½æœ‰æ•ˆé™ä½è¢«æ£€æµ‹çš„é£é™©ã€‚é€šè¿‡ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•åœ¨ Frida ä¸­æ‹¦æˆªçº¿ç¨‹åˆå§‹åŒ–ã€è§£æç”¨æˆ·ä»£ç å…¥å£ï¼Œå¹¶åœ¨æ”»é˜²å¯¹æŠ—ä¸­é€‰æ‹©æ€§æ”¾è¡Œçº¿ç¨‹ã€‚å¯¹äºé€†å‘å·¥ç¨‹å¸ˆæ¥è¯´ï¼ŒæŒæ¡è¿™ç§æ–¹æ³•ä¸ä»…èƒ½å¸®åŠ©ç»•è¿‡åè°ƒè¯•ï¼Œè¿˜èƒ½åœ¨åˆ†æå¤æ‚åº”ç”¨æ—¶æ›´å¿«æŠ“ä½é‡ç‚¹é€»è¾‘ã€‚è€Œä»é˜²å¾¡è§’åº¦æ¥çœ‹ï¼Œç†è§£æ”»å‡»è€…çš„æ‰‹æ®µä¹Ÿæœ‰åŠ©äºè®¾è®¡æ›´åŠ ç¨³å›ºçš„åè°ƒè¯•æœºåˆ¶ã€‚æ”»é˜²åŒæ–¹çš„æŒç»­è¾ƒé‡ï¼Œæ­£æ˜¯æ¨åŠ¨ç§»åŠ¨å®‰å…¨æŠ€æœ¯ä¸æ–­è¿›åŒ–çš„åŠ¨åŠ›ã€‚

å­¦ä¹ èµ„æº
====

ç«‹å³å…³æ³¨ã€äºŒè¿›åˆ¶ç£¨å‰‘ã€‘å…¬ä¼—å·

  

ğŸ‘‰ğŸ‘‰ğŸ‘‰[ã€IDA æŠ€å·§åˆé›†ã€‘](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Mjk2MTM1OQ==&action=getalbum&album_id=3353659750835535873#wechat_redirect)ğŸ‘ˆğŸ‘ˆğŸ‘ˆ

ğŸ‘‰ğŸ‘‰ğŸ‘‰[ã€Github å®‰å…¨é¡¹ç›®åˆé›†ã€‘](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Mjk2MTM1OQ==&action=getalbum&album_id=3257219530066477058#wechat_redirect)ğŸ‘ˆğŸ‘ˆğŸ‘ˆ

  

[![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/FMiaMMfBpPgAHcgEpVwNlwbjBT4E0PMAEaJrrdB5hsn6LWIqIBWP1YYNyyc3ISBVwjRlkQJB2ALvx5plHg4PHmA/640?wx_fmt=jpeg&from=appmsg&watermark=1)](https://mp.weixin.qq.com/s?__biz=MzI1Mjk2MTM1OQ==&mid=2247485678&idx=1&sn=2c4735f06b30c42926d0f12f3991d0c7&scene=21#wechat_redirect)